---
title: "Detecting Stress Using Wearables"
author: "Matty Pahren, Scott Heng On, Ethan Shen"
fontsize: 12pt
geometry: "left=1.3cm,right=1.3cm,top=1.3cm,bottom=1.3cm"
output: 
  pdf_document:
     latex_engine: xelatex
     number_sections: true
---

```{r, function checking for installed packages, include=FALSE}
# Validate that all necessary packaged have been downloaded, install otherwise or throw err package DNE
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,repos = "http://cran.r-project.org", dep=TRUE)
    if(!require(x,character.only = TRUE)) stop("Package not found")
  }
}
```

```{r include=FALSE}
# Installing packages 
pkgTest("tidyverse")
pkgTest("knitr")
pkgTest("kableExtra")
pkgTest("caret")
```

```{r include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(caret)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
ggplot2::theme_set(new = theme_bw())
```

```{r load-data}

survey <- read_csv("survey.csv")
final_data <- readRDS("final_data.Rds")
sub_data <- readRDS("subj_df.Rds")

survey <- survey %>%
  rename(label = Label)

sub_data <- sub_data %>%
  rename(participant = Participant)

all_data <- final_data %>% 
  left_join(survey, by=c("participant", "label")) %>% 
  left_join(sub_data, by=c("participant")) %>% 
  filter(label != 1) %>% 
  mutate(label = case_when(
    label ==  2 ~ 1,
    label == 3 ~ 0,
  )) %>% 
  mutate(label = as.factor(label)) 

```

```{r train-test}
set.seed(20200922)
idx = createDataPartition(all_data$label, p = 0.8, list = FALSE)
train = all_data[idx, ]
test = all_data[-idx, ]

train_control <- trainControl(method="repeatedcv", number = 5, savePredictions = T) # this is the cross validation

lr_model1 <- train(label ~ ., 
               data = train, trControl = train_control, 
               method="glm", family="binomial") # simple LR
```

```{r metrics}
calc_metrics = function(model) {
  list = list()
  acc_list = c()
  f1_list = c()
  AUC_list = c()
  
  for (i in 1:10) {
    fold <- model$pred %>% pull(Resample) %>% unique() %>% .[i]
    
    fold_df <- model$pred %>% 
      filter(Resample == fold)
    
    # accuracy
    acc <- mean(fold_df$pred == fold_df$obs)
    acc_list[i] <- acc
    
    # F1 score
    precision <- posPredValue(fold_df$pred, fold_df$obs, positive="1")
    recall <- sensitivity(fold_df$pred, fold_df$obs, positive="1")
    F1 <- (2 * precision * recall) / (precision + recall)
    f1_list[i] <- F1
    
    # AUC
    AUC_list[i] <- cvAUC::AUC(fold_df$pred %>% as.double(), fold_df$obs %>% as.double())
  }
  
  acc_mean = acc_list %>% mean(na.rm=T) %>% round_perc()
  acc_sd = acc_list %>% sd(na.rm=T) %>% round_perc()
  f1_mean = f1_list %>% mean(na.rm=T) %>% round_perc()
  f1_sd = f1_list %>% sd(na.rm=T) %>% round_perc()
  AUC_mean = AUC_list %>% mean(na.rm=T) %>% round_perc()
  AUC_sd = AUC_list %>% sd(na.rm=T) %>% round_perc()
  
  d <- tibble(
    Accuracy = paste(acc_mean, "±", acc_sd),
    F1 = paste(f1_mean, "±", f1_sd),
    AUC = paste(AUC_mean, "±", AUC_sd)
  )
  return(d)
}
# returns accuracy/F1score/AUC if you run the model using the previous  code
```




# Introduction 

Affect recognition seeks to detect a person’s affective state. One of these states is stress, and long-term stress is known to have severe implications on human health and well-being. This study uses the Wearable Stress and Affect Detection (WESAD) dataset, which was introduced in Schmidt et al. [[1]][Bibliography], and ___ (main results of the modeling or something). 

In conducting this analysis, we aim to determine whether sensor data are useful in predicting stress, and if so, which predictors are most significant when discriminating between stress and amusement. Furthermore, we seek to understand which types of sensor data are most useful in predicting stress, alone or in combination, and to determine if stress can be detected only using the wrist-worn wearable, which is more convenient to wear than a chest-worn device. Finally, we quantify the heterogeneity across individuals in their responses to stress by _____. 

# Literature Review 

# Data 

The WESAD dataset contains physiological and motion data on 15 test subjects. For this analysis, we used the raw data included in the provided pickle files, which synchronised the high resolution data from the chest-worn wearables and the lower resolution data from the wrist-worn wearables. The chest data, which were all recorded at 700 Hz, includes electrocardiography (ECG) data in mV, electrodermal activity (EDA) in microseconds, electromyography (EMG) data in mV, skin temperature (TEMP) in °C, displacement of the thorax for males and the abdomen for females induced by inhaling or exhaling (RESP) as a percentage, and 3-axis accelerometer (ACC) data in g - the acceleration of gravity. The wrist data includes blood volume pulse (BVP) data, ACC data in 1/64g, EDA in microseconds, and TEMP in °C; BVP was sampled at 64 Hz, ACC was sampled at 32 Hz, and EDA and TEMP were sampled at 4 Hz. 

Each sample also contains a label from 0-7 corresponding to the study protocol condition, where 2 refers to stress, and 3 refers to amusement. 1 is the baseline and 4 refers to meditation, but since we are mainly interested in discriminating between stress and amusement, we excluded these categories from our analysis. Samples labeled as 0, 5, 6, 7 should be ignored, and were also excluded from our analysis. 

The dataset also included information about each of the subject’s personal characteristics, such as their height and weight, as well as their responses to questionnaires, such as PANAS [[2]][Bibliography].

# Methodology

## Feature Engineering

The brain takes .9 milliseconds to shift a body into a full stress response, which suggests that these data should be sampled at approximately 1111 Hz to properly identify a state of stress. However, the highest-resolution data is sampled at 700 Hz, which suggests that these data are not granular enough to fully capture a shift to stress. Thus, with computational cost in mind, we downsampled our data to 4Hz. We assigned a unique ID to each of the 15 subjects, and also added their personal characteristics. Since we are primarily interested in differentiating between stress and amusement, we only kept samples that were labeled 2 (stress) or 3 (amusement). We then relabeled amusement as 0 and stress as 1.

Next, we calculated features for the different modalities, which are displayed in Table #.  Segmentation of the physiological signals was done using a sliding window, with a window shift of 0.25 seconds. The ACC and physiological features were both calculated with a 5 second window size [[3]][Bibliography] [[4]][Bibliography]. 

## Model Selection 

# Results 

## Testing MSE or something 

## Model Diagnostics 

# Discussion

# Conclusion 

# Appendix 

## Bibliography

1. P. Schmidt et al. (2018). Introducing WESAD, a Multimodal Dataset for Wearable Stress and Affect Detection. Proceedings of the 2018 on International Conference on Multimodal Interaction - ICMI 18.

2. D. Watson, L. A. Clark and A. Tellegen. (1988). Development and validation of brief measures of positive and negative affect: the PANAS scales. Journal of Personality and Social Psychology, 54, 6, 1063.

3. M. Arif and A. Kattan. (2015). Physical Activities Monitoring Using Wearable Acceleration Sensors Attached to the Body. PLoS ONE 10, 7.

4. G. Uy et al. (2013). Correlation of Stress Inducers and Physiological Signals with Continuous Stress Annotations. WCTP 2012, PICT 7, pp. 178–183.